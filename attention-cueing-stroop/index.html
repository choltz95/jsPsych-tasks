<!doctype html>
<html>
  <head>
    <title>Attention-Cueing-Stroop</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://choltz95.github.io/projects/jspsych-5.0.3/jspsych.js"></script>
    <script src="https://choltz95.github.io/projects/jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="https://choltz95.github.io/projects/jspsych-5.0.3/plugins/jspsych-textTimed.js"></script>
    <script src="https://choltz95.github.io/projects/jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <link href="https://choltz95.github.io/projects/jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <style> /* Ben King helped with this. */
        html, body {
        height: 100%;
        margin: 0;
        }
      body { font-size: 125%; } /* global font size */
      .box1 {
        display: inline-block;
        vertical-align: middle;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        /*
        width: 300px;
        height: 400px;*/
        
        width: 25%;
        height: 65%;
        
        padding: 1px;
        margin: 2em;
        border: 3px solid grey;
      }
      .box2 {
        display: inline-block;
        vertical-align: middle;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        /*width: 300px;
        height: 400px;*/
        width: 25%;
        height: 65%;
        padding: 1px;
        margin: 2em;
        border: 3px solid grey
      }
      .fixation_gap {
        display: inline-block;
        vertical-align: middle;
        width: 5%;
        height: 5%;
        padding: 1px;
        background: white;
        position: relative;
        text-align:center;
        font-size: 40px;
        margin: 2em;
      }
      .dot {
        display: inline-block;
        vertical-align: middle;
        Text-align:center;
        /*line-height: 400px;*/
      }
      .text {
        vertical-align: middle;
        top: 100%;
      }
      .jspsych-display-element {
        min-height: 100%;
        min-width:100%;
        width:100%; !important;
        overflow: hidden;
      }

      .box1 #jspsych-single-stim-stimulus, .box2 #jspsych-single-stim-stimulus {
        width: 100%;
        height: 100%;
        display:flex;
        justify-content:center;
        align-items:center;
      }
      #go {
        width: 30%;
        height: 80px;
        margin: 0 auto;
        -webkit-border-radius: 25px;
        -moz-border-radius: 25px;
        border-radius: 25px;
        background: red;
      }
      .jspsych-display-element h1 {
        width: 50%;
      }
    </style>
  </head>
  <body>
      <div class="jspsych_target" style="Text-align:center;width:100%;height:100%" id="jspsych_target"><!--
      --><div class="instructions"></div><!--
      --><div class="box1"></div><!--
      --><div class="fixation_gap">
            &#10010;
        </div><!--
      --><div class="box2"></div><!--
    --></div>
  </body>
  <script>
  var api_key = "11082366813cdc167d41fea137939cb35142673bc71a98d823";
  var api_secret = "A9UlsF6.fbaTE";
  var base_url = "https://restapi.surveygizmo.com/v5/survey/";
/* https://restapi.surveygizmo.com/v5/survey/3808247/surveypage/1/surveyquestion/1415/surveyoption?_method=PUT&title=data&value='{rvar:test}'&api_token=11082366813cdc167d41fea137939cb35142673bc71a98d823&api_token_secret=A9UlsF6.fbaTE
 */

  /* define instructions block */
  var instructions_block = {
    type: "text",
    display_element: $('.instructions'),
    text: "<p>You will shortly see a series of words on the screen. During each experimental trial, a vertically-aligned pair of words will appear printed in either the right box, or the left box. A &quot;&#9679;&quot; will appear on the screen in either the right box, or the left box after each set of words appears. Your task is to indicate what side of the screen the &quot;&#9679;&quot; appeared on, using the C and M keys. If the &quot;&#9679;&quot; appears on the left side of the screen, press C. If the &quot;&#9679;&quot; appears on the right side of the screen, press M. Try not to make mistakes, but try to be fast. Your reactions will be timed.</p>" +

      "<p>Press ANY KEY to start...</p>",
    on_trial_start: function() { $(".fixation_gap").css('visibility','hidden'); $(".box1").css('visibility','hidden'); $(".box2").css('visibility','hidden'); },
    on_finish: function() { $(".fixation_gap").css('visibility','visible'); $(".box1").css('visibility','visible'); $(".box2").css('visibility','visible');  },
    timing_post_trial: 4000
  };

  var fixation_block = {
    type: "single-stim",
    display_element: $('.box1'),
    stimulus:"",
    is_html: true,
    timing_response: 1000,
    timing_post_trial: 0,
    response_ends_trial: false,
    data:{
      block: 'fixation'
    }
  };

  var trial_end_block = {
    type: "single-stim",
    display_element: $('.box1'),
    stimulus:"",
    is_html: true,
    on_trial_start: function() { $(".fixation_gap").css('visibility','hidden'); },
    on_finish: function() { $(".fixation_gap").css('visibility','visible'); },
    timing_response: 1000,
    timing_post_trial: 0,
    response_ends_trial: false,
    data:{
      block: 'trial_end'
    }
  };

  var responsel_block = {
    type: "single-stim",
    //choices: ['c','m'],
    choices: [],
    display_element: $('.box1'),
    stimulus:"<div class='dot'><font size='+20'>&#9679;</font></div>",
    is_html: true,
    timing_response: 2000,
    timing_post_trial: 10,
    response_ends_trial: true,
    data:{key_pressed:-1},
    on_finish: function(data){
      trial_index++;
      //tldat = jsPsych.data.getLastTimelineData();
      //wpos = tldat[tldat.length - 2]['word_position'];
      if(data.key_press == 67) {
        jsPsych.data.addDataToLastTrial({key_pressed: 'c', participant_response:'left', correct_response: 'correct' });
      } else if (data.key_press == 77) {
        jsPsych.data.addDataToLastTrial({key_pressed: 'm', participant_response:'right', correct_response: 'incorrect' });
      } else if(data.key_press == -1) {
        jsPsych.data.addDataToLastTrial({correct_response: 'noresponse'});
      } else { jsPsych.data.addDataToLastTrial({key_pressed: String.fromCharCode(data.key_press).toLowerCase(), correct_response: 'incorrect'}); }
    },
    data:{
      dot_position: 'left'
    }
  };

  var responser_block = {
    type: "single-stim",
    //choices: ['c','m'],
    choices: [],
    display_element: $('.box2'),
    stimulus:"<div class='dot'><font size='+20'>&#9679;</font></div>",
    is_html: true,
    timing_response: 2000,
    timing_post_trial: 10,
    response_ends_trial: true,
    data:{key_pressed:-1},
    on_finish: function(data){
      trial_index++;
      //tldat = jsPsych.data.getLastTimelineData();
      //wpos = tldat[tldat.length - 2]['word_position'];
      if(data.key_press == 77) {
        jsPsych.data.addDataToLastTrial({key_pressed: 'm', participant_response:'right', correct_response: 'correct' });
      } else if (data.key_press == 67) {
        jsPsych.data.addDataToLastTrial({key_pressed: 'c', participant_response:'left', correct_response: 'incorrect' });
      } else if(data.key_press == -1) {
        jsPsych.data.addDataToLastTrial({correct_response: 'noresponse'});
      } else { jsPsych.data.addDataToLastTrial({key_pressed: String.fromCharCode(data.key_press).toLowerCase(), correct_response: 'incorrect'}); }
    },
    data:{
      dot_position: 'right'
    }
  };

  /* define test blocks */
  var practice_wordlist = ["follow", "walk", "spin", "pile", "wide", "rusty", "parking", "known", "zoom", "decide", "run", "writing"];
  var suicide_wordlist = ["suffocation", "gunshot", "funeral", "blood", "overdose", "noose", "corpse", "death", "dead", "die", "cutting", "dying", "suicide", "hanging", "killing", "deceased"];
  var negative_wordlist = ["hate", "vomit", "pathetic", "crying", "filthy","abuse", "cruel", "failure", "assault", "rejected", "bomb", "torture", "ashamed", "alone", "stupid", "worthless"];
  var positive_wordlist = ["healthy", "attraction", "great", "paradise", "love", "bravery", "pleasure", "enthusiasm", "kiss", "strong", "smile", "happy", "passionate", "ecstatic", "laugh", "success"];
  var neutral_wordlist = ["statue", "folded", "image", "cheese", "horse", "foam", "table", "paper", "closet", "meter", "museum", "green", "frame", "double", "structure", "engine"];
  var test_wordlist =  suicide_wordlist.concat(negative_wordlist, positive_wordlist, neutral_wordlist)
  var practice_stimuli = [];
  var stim_practice_set = []; // temporary object array for randomization of stim order
  var stim_test_set = []; // temporary object array for randomization of stim order
  var test_stimuli1 = []; // block 1
  var test_stimuli2 = []; // block 2
  var test_stimuli3 = []; // block 3
  var test_stimuli4 = []; // block 4
  var trial_index = 0;

  for(var i=0;i<practice_wordlist.length;i++) {
    var rand1 = Math.floor(Math.random() * 2) + 1;
    var rand2 = Math.floor(Math.random() * 2) + 1;
    var wp = "";
    if(rand1 == 1) {
      wp = "left";
    } else { wp = "right";}
    var stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box' + rand1),
      stimulus: "<div class='text'><span><h3>" + practice_wordlist[i] + "</h3></span>" + "<span><h3>" + practice_wordlist[i] + "</h3></span></div>",
      data:{word: practice_wordlist[i],
            word_position: wp,
            validity: 'practice',
            block: 'practice',
            block_num: 0
      }
    }
    stim_practice_set = [];
    stim_practice_set.push(fixation_block);
    stim_practice_set.push(stim);
    if(rand2 == 1) {
      stim_practice_set.push(responser_block);
    } else {
      stim_practice_set.push(responsel_block);
    }
    stim_practice_set.push(trial_end_block); // trick to preserve order of stimuli set
    practice_stimuli.push(stim_practice_set);
  }
  var practice_trials = jsPsych.randomization.repeat(practice_stimuli, 1);
  practice_trials = [].concat.apply([], practice_trials); // flatten

  var practice_block = {
    type: "single-stim",
    timeline: practice_trials
  };

  var practice_debrief_block = {
    type: "text",
    display_element: $('.instructions'),
    on_trial_start: function() { $(".fixation_gap").css('visibility','hidden'); $(".box1").css('visibility','hidden'); $(".box2").css('visibility','hidden'); },
    on_finish: function() { $(".fixation_gap").css('visibility','visible'); $(".box1").css('visibility','visible'); $(".box2").css('visibility','visible');  },
    text: function() {
      return "<p>You have completed the PRACTICE phase. If you would like to repeat the PRACTICE phase, press 1. If you would like to continue onto the TEST phase, press the spacebar.</p>";
    }
  };

  /* create practice timeline */
  var practice_timeline = [];
  practice_timeline.push(instructions_block);
  practice_timeline.push(practice_block);
  practice_timeline.push(practice_debrief_block);

  var practice_node = {
    timeline: practice_timeline,
    loop_function: function(data){
      if(49 == data[data.length-1].key_press) {
        return true;
      } else {
        return false;
      }
    }
  };

/*********************************/

  // Block 1
  for(var i=0; i<4; i++) {
    var suicide_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + suicide_wordlist[i] + "</h3></span>" + "<span><h3>" + suicide_wordlist[i] + "</h3></span></div>",
      data:{word: suicide_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 1,
            word_type:'suicide'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(suicide_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli1.push(stim_test_set);
  }
  for(var i=0; i<4; i++) {
    var neutral_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + neutral_wordlist[i] + "</h3></span>" + "<span><h3>" + neutral_wordlist[i] + "</h3></span></div>",
      data:{word: neutral_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 1,
            word_type:'neutral'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(neutral_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli1.push(stim_test_set);
  }
  for(var i=0; i<4; i++) {
    var positive_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + positive_wordlist[i] + "</h3></span>" + "<span><h3>" + positive_wordlist[i] + "</h3></span></div>",
      data:{word: positive_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 1,
            word_type:'positive'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(positive_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli1.push(stim_test_set);
  }
  for(var i=0; i<4; i++) {
    var negative_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + negative_wordlist[i] + "</h3></span>" + "<span><h3>" + negative_wordlist[i] + "</h3></span></div>",
      data:{word: negative_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 1,
            word_type:'negative'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(negative_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli1.push(stim_test_set);
  }
  // test_stimuli1[][0] fixation block
  // test_stimuli1[][1] stim
  // test_stimuli1[][2] response block
  // test_stimuli1[][3] trial end block

  // suicide
  test_stimuli1[0][1]['display_element'] = $('.box1');
  test_stimuli1[0][1]['data']['word_position'] = 'left';
  test_stimuli1[0][1]['data']['validity'] = 'invalid';
  test_stimuli1[0][2] = responser_block;

  test_stimuli1[1][1]['display_element'] = $('.box2');
  test_stimuli1[1][1]['data']['word_position'] = 'right';
  test_stimuli1[1][2] = responser_block;

  test_stimuli1[2][1]['display_element'] = $('.box2');
  test_stimuli1[2][1]['data']['word_position'] = 'right';
  test_stimuli1[2][2] = responser_block;

  test_stimuli1[3][1]['display_element'] = $('.box1');
  test_stimuli1[3][1]['data']['word_position'] = 'left';
  test_stimuli1[3][2] = responsel_block;

  // neutral
  test_stimuli1[4][1]['display_element'] = $('.box2');
  test_stimuli1[4][1]['data']['word_position'] = 'right';
  test_stimuli1[4][1]['data']['validity'] = 'invalid';
  test_stimuli1[4][2] = responsel_block;

  test_stimuli1[5][1]['display_element'] = $('.box1');
  test_stimuli1[5][1]['data']['word_position'] = 'left';
  test_stimuli1[5][2] = responsel_block;

  test_stimuli1[6][1]['display_element'] = $('.box1');
  test_stimuli1[6][1]['data']['word_position'] = 'left';
  test_stimuli1[6][2] = responsel_block;

  test_stimuli1[7][1]['display_element'] = $('.box2');
  test_stimuli1[7][1]['data']['word_position'] = 'right';
  test_stimuli1[7][2] = responser_block;

  // positive
  test_stimuli1[8][1]['display_element'] = $('.box1');
  test_stimuli1[8][1]['data']['word_position'] = 'left';
  test_stimuli1[8][1]['data']['validity'] = 'invalid';
  test_stimuli1[8][2] = responser_block;

  test_stimuli1[9][1]['display_element'] = $('.box2');
  test_stimuli1[9][1]['data']['word_position'] = 'right';
  test_stimuli1[9][2] = responser_block;

  test_stimuli1[10][1]['display_element'] = $('.box2');
  test_stimuli1[10][1]['data']['word_position'] = 'right';
  test_stimuli1[10][2] = responser_block;

  test_stimuli1[11][1]['display_element'] = $('.box1');
  test_stimuli1[11][1]['data']['word_position'] = 'left';
  test_stimuli1[11][2] = responsel_block;

  // negative
  test_stimuli1[12][1]['display_element'] = $('.box2');
  test_stimuli1[12][1]['data']['word_position'] = 'right';
  test_stimuli1[12][1]['data']['validity'] = 'invalid';
  test_stimuli1[12][2] = responsel_block;

  test_stimuli1[13][1]['display_element'] = $('.box1');
  test_stimuli1[13][1]['data']['word_position'] = 'left';
  test_stimuli1[13][2] = responsel_block;

  test_stimuli1[14][1]['display_element'] = $('.box1');
  test_stimuli1[14][1]['data']['word_position'] = 'left';
  test_stimuli1[14][2] = responsel_block;

  test_stimuli1[15][1]['display_element'] = $('.box2');
  test_stimuli1[15][1]['data']['word_position'] = 'right';
  test_stimuli1[15][2] = responser_block;

  var test_trials1 = jsPsych.randomization.repeat(test_stimuli1, 1);
  test_trials1 = [].concat.apply([], test_trials1); // flatten

  // Block 2
  for(var i=4; i<8; i++) {
    var suicide_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + suicide_wordlist[i] + "</h3></span>" + "<span><h3>" + suicide_wordlist[i] + "</h3></span></div>",
      data:{word: suicide_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 2,
            word_type:'suicide'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(suicide_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli2.push(stim_test_set);
  }
  for(var i=4; i<8; i++) {
    var neutral_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + neutral_wordlist[i] + "</h3></span>" + "<span><h3>" + neutral_wordlist[i] + "</h3></span></div>",
      data:{word: neutral_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 2,
            word_type:'neutral'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(neutral_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli2.push(stim_test_set);
  }
  for(var i=4; i<8; i++) {
    var positive_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + positive_wordlist[i] + "</h3></span>" + "<span><h3>" + positive_wordlist[i] + "</h3></span></div>",
      data:{word: positive_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 2,
            word_type:'positive'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(positive_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli2.push(stim_test_set);
  }
  for(var i=4; i<8; i++) {
    var negative_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + negative_wordlist[i] + "</h3></span>" + "<span><h3>" + negative_wordlist[i] + "</h3></span></div>",
      data:{word: negative_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 2,
            word_type:'negative'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(negative_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli2.push(stim_test_set);
  }
  // test_stimuli1[][0] fixation block
  // test_stimuli1[][1] stim
  // test_stimuli1[][2] response block
  // test_stimuli1[][3] trial end block

  // suicide
  test_stimuli2[0][1]['display_element'] = $('.box2');
  test_stimuli2[0][1]['data']['word_position'] = 'right';
  test_stimuli2[0][1]['data']['validity'] = 'invalid';
  test_stimuli2[0][2] = responsel_block;

  test_stimuli2[1][1]['display_element'] = $('.box1');
  test_stimuli2[1][1]['data']['word_position'] = 'left';
  test_stimuli2[1][2] = responsel_block;

  test_stimuli2[2][1]['display_element'] = $('.box1');
  test_stimuli2[2][1]['data']['word_position'] = 'left';
  test_stimuli2[2][2] = responsel_block;

  test_stimuli2[3][1]['display_element'] = $('.box2');
  test_stimuli2[3][1]['data']['word_position'] = 'right';
  test_stimuli2[3][2] = responser_block;

  // neutral
  test_stimuli2[4][1]['display_element'] = $('.box1');
  test_stimuli2[4][1]['data']['word_position'] = 'left';
  test_stimuli2[4][1]['data']['validity'] = 'invalid';
  test_stimuli2[4][2] = responser_block;

  test_stimuli2[5][1]['display_element'] = $('.box2');
  test_stimuli2[5][1]['data']['word_position'] = 'right';
  test_stimuli2[5][2] = responser_block;

  test_stimuli2[6][1]['display_element'] = $('.box2');
  test_stimuli2[6][1]['data']['word_position'] = 'right';
  test_stimuli2[6][2] = responser_block;

  test_stimuli2[7][1]['display_element'] = $('.box1');
  test_stimuli2[7][1]['data']['word_position'] = 'left';
  test_stimuli2[7][2] = responsel_block;

  // positive
  test_stimuli2[8][1]['display_element'] = $('.box2');
  test_stimuli2[8][1]['data']['word_position'] = 'right';
  test_stimuli2[8][1]['data']['validity'] = 'invalid';
  test_stimuli2[8][2] = responsel_block;

  test_stimuli2[9][1]['display_element'] = $('.box1');
  test_stimuli2[9][1]['data']['word_position'] = 'left';
  test_stimuli2[9][2] = responsel_block;

  test_stimuli2[10][1]['display_element'] = $('.box1');
  test_stimuli2[10][1]['data']['word_position'] = 'left';
  test_stimuli2[10][2] = responsel_block;

  test_stimuli2[11][1]['display_element'] = $('.box2');
  test_stimuli2[11][1]['data']['word_position'] = 'right';
  test_stimuli2[11][2] = responser_block;

  // negative
  test_stimuli2[12][1]['display_element'] = $('.box1');
  test_stimuli2[12][1]['data']['word_position'] = 'left';
  test_stimuli2[12][1]['data']['validity'] = 'invalid';
  test_stimuli2[12][2] = responser_block;

  test_stimuli2[13][1]['display_element'] = $('.box2');
  test_stimuli2[13][1]['data']['word_position'] = 'right';
  test_stimuli2[13][2] = responser_block;

  test_stimuli2[14][1]['display_element'] = $('.box2');
  test_stimuli2[14][1]['data']['word_position'] = 'right';
  test_stimuli2[14][2] = responser_block;

  test_stimuli2[15][1]['display_element'] = $('.box1');
  test_stimuli2[15][1]['data']['word_position'] = 'left';
  test_stimuli2[15][2] = responsel_block;

  var test_trials2 = jsPsych.randomization.repeat(test_stimuli2, 1);
  test_trials2 = [].concat.apply([], test_trials2); // flatten

  // Block 3
  for(var i=8; i<12; i++) {
    var suicide_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + suicide_wordlist[i] + "</h3></span>" + "<span><h3>" + suicide_wordlist[i] + "</h3></span></div>",
      data:{word: suicide_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 3,
            word_type:'suicide'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(suicide_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli3.push(stim_test_set);
  }
  for(var i=8; i<12; i++) {
    var neutral_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + neutral_wordlist[i] + "</h3></span>" + "<span><h3>" + neutral_wordlist[i] + "</h3></span></div>",
      data:{word: neutral_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 3,
            word_type:'neutral'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(neutral_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli3.push(stim_test_set);
  }
  for(var i=8; i<12; i++) {
    var positive_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + positive_wordlist[i] + "</h3></span>" + "<span><h3>" + positive_wordlist[i] + "</h3></span></div>",
      data:{word: positive_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 3,
            word_type:'positive'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(positive_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli3.push(stim_test_set);
  }
  for(var i=8; i<12; i++) {
    var negative_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + negative_wordlist[i] + "</h3></span>" + "<span><h3>" + negative_wordlist[i] + "</h3></span></div>",
      data:{word: negative_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 3,
            word_type: 'negative'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(negative_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli3.push(stim_test_set);
  }
  // test_stimuli1[][0] fixation block
  // test_stimuli1[][1] stim
  // test_stimuli1[][2] response block
  // test_stimuli1[][3] trial end block

  // suicide
  test_stimuli3[0][1]['display_element'] = $('.box1');
  test_stimuli3[0][1]['data']['word_position'] = 'left';
  test_stimuli3[0][1]['data']['validity'] = 'invalid';
  test_stimuli3[0][2] = responser_block;

  test_stimuli3[1][1]['display_element'] = $('.box2');
  test_stimuli3[1][1]['data']['word_position'] = 'right';
  test_stimuli3[1][2] = responser_block;

  test_stimuli3[2][1]['display_element'] = $('.box2');
  test_stimuli3[2][1]['data']['word_position'] = 'right';
  test_stimuli3[2][2] = responser_block;

  test_stimuli3[3][1]['display_element'] = $('.box1');
  test_stimuli3[3][1]['data']['word_position'] = 'left';
  test_stimuli3[3][2] = responsel_block;

  // neutral
  test_stimuli3[4][1]['display_element'] = $('.box2');
  test_stimuli3[4][1]['data']['word_position'] = 'right';
  test_stimuli3[4][1]['data']['validity'] = 'invalid';
  test_stimuli3[4][2] = responsel_block;

  test_stimuli3[5][1]['display_element'] = $('.box1');
  test_stimuli3[5][1]['data']['word_position'] = 'left';
  test_stimuli3[5][2] = responsel_block;

  test_stimuli3[6][1]['display_element'] = $('.box1');
  test_stimuli3[6][1]['data']['word_position'] = 'left';
  test_stimuli3[6][2] = responsel_block;

  test_stimuli3[7][1]['display_element'] = $('.box2');
  test_stimuli3[7][1]['data']['word_position'] = 'right';
  test_stimuli3[7][2] = responser_block;

  // positive
  test_stimuli3[8][1]['display_element'] = $('.box2');
  test_stimuli3[8][1]['data']['word_position'] = 'right';
  test_stimuli3[8][1]['data']['validity'] = 'invalid';
  test_stimuli3[8][2] = responsel_block;

  test_stimuli3[9][1]['display_element'] = $('.box1');
  test_stimuli3[9][1]['data']['word_position'] = 'left';
  test_stimuli3[9][2] = responsel_block;

  test_stimuli3[10][1]['display_element'] = $('.box1');
  test_stimuli3[10][1]['data']['word_position'] = 'left';
  test_stimuli3[10][2] = responsel_block;

  test_stimuli3[11][1]['display_element'] = $('.box2');
  test_stimuli3[11][1]['data']['word_position'] = 'right';
  test_stimuli3[11][2] = responser_block;

  // negative
  test_stimuli3[12][1]['display_element'] = $('.box1');
  test_stimuli3[12][1]['data']['word_position'] = 'left';
  test_stimuli3[12][1]['data']['validity'] = 'invalid';
  test_stimuli3[12][2] = responser_block;

  test_stimuli3[13][1]['display_element'] = $('.box2');
  test_stimuli3[13][1]['data']['word_position'] = 'right';
  test_stimuli3[13][2] = responser_block;

  test_stimuli3[14][1]['display_element'] = $('.box2');
  test_stimuli3[14][1]['data']['word_position'] = 'right';
  test_stimuli3[14][2] = responser_block;

  test_stimuli3[15][1]['display_element'] = $('.box1');
  test_stimuli3[15][1]['data']['word_position'] = 'left';
  test_stimuli3[15][2] = responsel_block;

  var test_trials3 = jsPsych.randomization.repeat(test_stimuli3, 1);
  test_trials3 = [].concat.apply([], test_trials3); // flatten

  // Block 4
  for(var i=12; i<16; i++) {
    var suicide_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + suicide_wordlist[i] + "</h3></span>" + "<span><h3>" + suicide_wordlist[i] + "</h3></span></div>",
      data:{word: suicide_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 4,
            word_type:'suicide'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(suicide_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli4.push(stim_test_set);
  }
  for(var i=12; i<16; i++) {
    var neutral_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + neutral_wordlist[i] + "</h3></span>" + "<span><h3>" + neutral_wordlist[i] + "</h3></span></div>",
      data:{word: neutral_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 4,
            word_type:'neutral'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(neutral_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli4.push(stim_test_set);
  }
  for(var i=12; i<16; i++) {
    var positive_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + positive_wordlist[i] + "</h3></span>" + "<span><h3>" + positive_wordlist[i] + "</h3></span></div>",
      data:{word: positive_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 4,
            word_type:'positive'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(positive_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli4.push(stim_test_set);
  }
  for(var i=12; i<16; i++) {
    var negative_stim = {
      is_html: true,
      timing_response: 1000,
      timing_post_trial: 50,
      response_ends_trial: false,
      display_element: $('.box1'),
      stimulus: "<div class='text'><span><h3>" + negative_wordlist[i] + "</h3></span>" + "<span><h3>" + negative_wordlist[i] + "</h3></span></div>",
      data:{word: negative_wordlist[i],
            word_position: 'left',
            validity: 'valid',
            block: 'test',
            block_num: 4,
            word_type:'negative'
      }
    }
    stim_test_set = [];
    stim_test_set.push(fixation_block);
    stim_test_set.push(negative_stim);
    stim_test_set.push(responser_block);
    stim_test_set.push(trial_end_block);
    test_stimuli4.push(stim_test_set);
  }
  // test_stimuli1[][0] fixation block
  // test_stimuli1[][1] stim
  // test_stimuli1[][2] response block
  // test_stimuli1[][3] trial end block

  // suicide
  test_stimuli4[0][1]['display_element'] = $('.box2');
  test_stimuli4[0][1]['data']['word_position'] = 'right';
  test_stimuli4[0][1]['data']['validity'] = 'invalid';
  test_stimuli4[0][2] = responsel_block;

  test_stimuli4[1][1]['display_element'] = $('.box1');
  test_stimuli4[1][1]['data']['word_position'] = 'left';
  test_stimuli4[1][2] = responsel_block;

  test_stimuli4[2][1]['display_element'] = $('.box1');
  test_stimuli4[2][1]['data']['word_position'] = 'left';
  test_stimuli4[2][2] = responsel_block;

  test_stimuli4[3][1]['display_element'] = $('.box2');
  test_stimuli4[3][1]['data']['word_position'] = 'right';
  test_stimuli4[3][2] = responser_block;

  // neutral
  test_stimuli4[4][1]['display_element'] = $('.box1');
  test_stimuli4[4][1]['data']['word_position'] = 'left';
  test_stimuli4[4][1]['data']['validity'] = 'invalid';
  test_stimuli4[4][2] = responser_block;

  test_stimuli4[5][1]['display_element'] = $('.box2');
  test_stimuli4[5][1]['data']['word_position'] = 'right';
  test_stimuli4[5][2] = responser_block;

  test_stimuli4[6][1]['display_element'] = $('.box2');
  test_stimuli4[6][1]['data']['word_position'] = 'right';
  test_stimuli4[6][2] = responser_block;

  test_stimuli4[7][1]['display_element'] = $('.box1');
  test_stimuli4[7][1]['data']['word_position'] = 'left';
  test_stimuli4[7][2] = responsel_block;

  // positive
  test_stimuli4[8][1]['display_element'] = $('.box1');
  test_stimuli4[8][1]['data']['word_position'] = 'left';
  test_stimuli4[8][1]['data']['validity'] = 'invalid';
  test_stimuli4[8][2] = responser_block;

  test_stimuli4[9][1]['display_element'] = $('.box2');
  test_stimuli4[9][1]['data']['word_position'] = 'right';
  test_stimuli4[9][2] = responser_block;

  test_stimuli4[10][1]['display_element'] = $('.box2');
  test_stimuli4[10][1]['data']['word_position'] = 'right';
  test_stimuli4[10][2] = responser_block;

  test_stimuli4[11][1]['display_element'] = $('.box1');
  test_stimuli4[11][1]['data']['word_position'] = 'left';
  test_stimuli4[11][2] = responsel_block;

  // negative
  test_stimuli4[12][1]['display_element'] = $('.box2');
  test_stimuli4[12][1]['data']['word_position'] = 'right';
  test_stimuli4[12][1]['data']['validity'] = 'invalid';
  test_stimuli4[12][2] = responsel_block;

  test_stimuli4[13][1]['display_element'] = $('.box1');
  test_stimuli4[13][1]['data']['word_position'] = 'left';
  test_stimuli4[13][2] = responsel_block;

  test_stimuli4[14][1]['display_element'] = $('.box1');
  test_stimuli4[14][1]['data']['word_position'] = 'left';
  test_stimuli4[14][2] = responsel_block;

  test_stimuli4[15][1]['display_element'] = $('.box2');
  test_stimuli4[15][1]['data']['word_position'] = 'right';
  test_stimuli4[15][2] = responser_block;

  var test_trials4 = jsPsych.randomization.repeat(test_stimuli4, 1);
  test_trials4 = [].concat.apply([], test_trials4); // flatten

  var test_block1 = {
    type: "single-stim",
    timeline: test_trials1
  };
  var test_block2 = {
    type: "single-stim",
    timeline: test_trials2
  };
  var test_block3 = {
    type: "single-stim",
    timeline: test_trials3
  };
  var test_block4 = {
    type: "single-stim",
    timeline: test_trials4
  };

  var test_debrief_block = {
    type: "textTimed",
    display_element: $('.instructions'),
    timeLeft: 1,
    text: function() {
      $(".box1").remove();
      $(".box2").remove();
      $(".fixation_gap").remove();
      $(".dot").remove();
      return "<p>End of task. Thank you for completing the task! Please do not continue until the symbol has turned green.</p><p><b>Please be patient, it may take 1-2 minutes to process your results. Do NOT hit next until the symbol is green.<b></p><div id='go'></div>";
    }
  };

  var test_timeline = [];
  test_timeline.push(test_block1);
  test_timeline.push(test_block2);
  test_timeline.push(test_block3);
  test_timeline.push(test_block4);
  test_timeline_rand = jsPsych.randomization.repeat(test_timeline, 1);
  
  test_timeline_rand.push(test_debrief_block);

  var test_node = {
    type: "single-stim",
    timeline: test_timeline_rand
  }
  
  function findAndRemove(array, property, value) {
    array.forEach(function(result, index) {
      if(result[property] === value) {
        //Remove from array
        array.splice(index, 1);
      }
    });
  }
  
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }
  var rid = getParameterByName('rid');
  console.log(rid);

  /* start the experiment */
  // Surveygizmo data ids
  //ids = [13414,13415,13416,13417,13418]
  idds = [1542, 1718, 1719, 1720, 1721,1807,1808,1809,1811,1812,1813,1814,1815,1816,1817]
  numpartitions = 15

  jsPsych.init({
    timeline: [practice_node,test_node],
    //timeline: [practice_node],
    
    on_finish: function() {
     //jsPsych.data.localSave('data.csv', 'csv');
      console.log('done');
      var json_data = JSON.parse(jsPsych.data.dataAsJSON());
      
      var chunksize = Math.ceil(json_data.length/numpartitions);
      var json_datas = [];
      while (json_data.length > 0){
        json_datas.push(json_data.splice(0, chunksize));
      }
      
      json_data_strs = []
      for(var i = 0; i < json_datas.length; i++) {
        findAndRemove(json_datas[i],'block','fixation');
        json_data_strs.push(JSON.stringify(json_datas[i]))
      }
      
      var responseid = -1
      var ridqid = 1913
      var url = `${base_url}3808247/surveyresponse.jsonp?_method=PUT&api_token=${api_key}&api_token_secret=${api_secret}&data[${ridqid}][value]=${rid}`;

      $.ajax({
          url: url,
          type: 'PUT',
          jsonp: "callback",
          dataType: "jsonp",
          success: function( response ) {
            console.log(response);
            responseid = response['data']['id']; // server response
            console.log(responseid)
            
              //for(var i = 0; i<numpartitions; i++){
              var i = 0;
              (testt = function() {
                  d = encodeURIComponent(json_data_strs[i]);
                  /*var url = `${base_url}3808247/surveypage/1/surveyquestion/${idds[i]}.jsonp?_method=POST&api_token=${api_key}&api_token_secret=${api_secret}&properties[defaulttext]=${d}`;*/
                  var url = `${base_url}3808247/surveyresponse/${responseid}.jsonp?_method=POST&api_token=${api_key}&api_token_secret=${api_secret}&data[${idds[i]}][value]=${d}`;
      
                  $.ajax({
                      async: true,
                      url: url,
                      type: 'POST',
                      jsonp: "callback",
                      dataType: "jsonp",
                      //data: {value: encodeURIComponent(json_data_strs[i])},
                      success: function( response ) {
                        console.log(response);
                        i++;
                        if(i < numpartitions) { setTimeout(testt(),1200);}
                        else { $("#go").css("background", "green"); }
                          //rid = response['data']['id']; // server response
                      }
                  });
                })();
            //}
          }
      });
    }
  });
</script>
</html>
